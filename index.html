<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Undertale Battle Fix</title>
    <style>
        body { background: #000; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; font-family: 'Courier New', monospace; }
        canvas { border: 2px solid #fff; margin-top: 20px; image-rendering: pixelated; }
        .controls { margin-top: 10px; color: #888; font-size: 14px; }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div class="controls">Setas: Mover | Z: Atacar/Interagir | X: Cancelar</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // ESTADOS: 'OVERWORLD', 'DIALOGUE', 'BATTLE_MENU', 'BATTLE_DODGE', 'VICTORY'
    let gameState = 'OVERWORLD';
    let dialogueText = "";
    let battleTimer = 0;
    let invencibilityFrames = 0;

    // INPUTS
    const keys = {};
    window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    // ENTIDADES
    const player = { x: 300, y: 220, w: 16, h: 16, hp: 20, maxHp: 20, speed: 3 };
    
    let npcs = [
        { id: 1, x: 200, y: 200, w: 20, h: 20, color: 'yellow', msg: "Cuidado com o inimigo roxo!", isEnemy: false },
        { id: 2, x: 400, y: 200, w: 24, h: 24, color: 'purple', hp: 60, maxHp: 60, isEnemy: true }
    ];

    const walls = [
        {x: 50, y: 50, w: 540, h: 10}, {x: 50, y: 420, w: 540, h: 10},
        {x: 50, y: 50, w: 10, h: 380}, {x: 580, y: 50, w: 10, h: 380}
    ];

    let currentEnemy = null;
    let bullets = [];
    const battleBox = { x: 220, y: 240, w: 200, h: 140 };

    // UTILITÁRIOS
    function rectsColliding(r1, r2) {
        return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
    }

    // LÓGICA DE BATALHA
    function startBattle(enemy) {
        currentEnemy = enemy;
        gameState = 'BATTLE_MENU';
        player.x = battleBox.x + battleBox.w/2 - 8;
        player.y = battleBox.y + battleBox.h/2 - 8;
    }

    function playerAttack() {
        if (gameState !== 'BATTLE_MENU') return;
        
        // Causa dano ao inimigo
        currentEnemy.hp -= 20;
        
        if (currentEnemy.hp <= 0) {
            gameState = 'VICTORY';
        } else {
            // Se o inimigo sobreviveu, ele ataca
            gameState = 'BATTLE_DODGE';
            battleTimer = 180; // ~3 segundos
            bullets = [];
        }
    }

    function update() {
        if (invencibilityFrames > 0) invencibilityFrames--;

        if (gameState === 'OVERWORLD') {
            let dx = 0, dy = 0;
            if (keys['arrowup']) dy -= player.speed;
            if (keys['arrowdown']) dy += player.speed;
            if (keys['arrowleft']) dx -= player.speed;
            if (keys['arrowright']) dx += player.speed;

            // Colisão Paredes
            if (!walls.some(w => rectsColliding({x: player.x + dx, y: player.y, w: player.w, h: player.h}, w))) player.x += dx;
            if (!walls.some(w => rectsColliding({x: player.x, y: player.y + dy, w: player.w, h: player.h}, w))) player.y += dy;

            // Interação
            if (keys['z']) {
                npcs.forEach(n => {
                    if (rectsColliding(player, n)) {
                        if (n.isEnemy) startBattle(n);
                        else { dialogueText = n.msg; gameState = 'DIALOGUE'; keys['z'] = false; }
                    }
                });
            }
        } 
        
        else if (gameState === 'DIALOGUE' && keys['z']) {
            gameState = 'OVERWORLD';
            keys['z'] = false;
        }

        else if (gameState === 'BATTLE_MENU' && keys['z']) {
            playerAttack();
            keys['z'] = false;
        }

        else if (gameState === 'BATTLE_DODGE') {
            // Movimento da Alma
            if (keys['arrowup'] && player.y > battleBox.y) player.y -= 3;
            if (keys['arrowdown'] && player.y < battleBox.y + battleBox.h - player.h) player.y += 3;
            if (keys['arrowleft'] && player.x > battleBox.x) player.x -= 3;
            if (keys['arrowright'] && player.x < battleBox.x + battleBox.w - player.w) player.x += 3;

            // Spawn de balas
            if (battleTimer % 15 === 0) {
                bullets.push({ x: battleBox.x + Math.random() * battleBox.w, y: battleBox.y - 10, w: 8, h: 8, vy: 4 });
            }

            // Colisão com balas
            bullets.forEach((b, i) => {
                b.y += b.vy;
                if (rectsColliding(player, b) && invencibilityFrames === 0) {
                    player.hp -= 4;
                    invencibilityFrames = 40;
                }
                if (b.y > battleBox.y + battleBox.h) bullets.splice(i, 1);
            });

            battleTimer--;
            if (battleTimer <= 0) gameState = 'BATTLE_MENU';
            if (player.hp <= 0) { alert("Sua alma se partiu..."); location.reload(); }
        }

        else if (gameState === 'VICTORY') {
            npcs = npcs.filter(n => n.id !== currentEnemy.id); // Remove inimigo
            dialogueText = "VOCÊ VENCEU! O inimigo fugiu.";
            gameState = 'DIALOGUE';
        }
    }

    function draw() {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameState === 'OVERWORLD' || gameState === 'DIALOGUE') {
            ctx.fillStyle = '#333';
            walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));
            npcs.forEach(n => { ctx.fillStyle = n.color; ctx.fillRect(n.x, n.y, n.w, n.h); });
            ctx.fillStyle = 'red';
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }

        if (gameState.includes('BATTLE')) {
            // Desenha Inimigo
            ctx.fillStyle = 'purple';
            ctx.fillRect(270, 80, 100, 100);
            
            // Barra de vida do Inimigo
            ctx.fillStyle = 'red';
            ctx.fillRect(270, 60, 100, 10);
            ctx.fillStyle = '#0f0';
            ctx.fillRect(270, 60, (currentEnemy.hp / currentEnemy.maxHp) * 100, 10);

            // Caixa de Batalha
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.strokeRect(battleBox.x, battleBox.y, battleBox.w, battleBox.h);

            // Alma (pisca se invencível)
            if (invencibilityFrames % 4 < 2) {
                ctx.fillStyle = 'red';
                ctx.fillRect(player.x, player.y, player.w, player.h);
            }

            // Balas
            ctx.fillStyle = 'white';
            bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

            // HUD HP Player
            ctx.fillStyle = 'white';
            ctx.font = '20px Courier New';
            ctx.fillText(`HP: ${player.hp}/${player.maxHp}`, 220, 420);

            if (gameState === 'BATTLE_MENU') {
                ctx.fillText("* O Inimigo te encara.", 70, 280);
                ctx.fillStyle = 'yellow';
                ctx.fillText("> [Z] LUTAR", 70, 320);
            }
        }

        if (gameState === 'DIALOGUE') {
            ctx.fillStyle = 'black';
            ctx.fillRect(40, 320, 560, 120);
            ctx.strokeStyle = 'white';
            ctx.strokeRect(40, 320, 560, 120);
            ctx.fillStyle = 'white';
            ctx.fillText(dialogueText, 60, 370);
        }
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>